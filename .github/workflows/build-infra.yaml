name: Build Infra

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  run:
    name: run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Install the terraform and terragrunt
      - uses: alexellis/setup-arkade@v1
      - uses: alexellis/arkade-get@master
        with:
          terraform: latest
          terragrunt: latest

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.PERSONAL_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.PERSONAL_SECRET_ACCESS_KEY }}
          role-to-assume: ${{ secrets.ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
          role-skip-session-tagging: true

      # Display IAM Identity
      - name: Display IAM Identity
        run: |
          aws sts get-caller-identity

      - name: Install jq
        run: |
          apt install jq

      - name: Get ECR arn
        run: |
          echo "ecr_arn=`terragrunt output --json | jq .ecr_repository_arn.value -r`" >> GITHUB_OUTPUT
        working-directory: ./terraform

      - name: Fetch ECS Repo Url
        run: |
          echo $ECR_ARN

      # Build docker image
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Build and push
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: user/app:latest
